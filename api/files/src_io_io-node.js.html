<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/io/io-node.js - Parcela</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="Parcela"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Event.html">Event</a></li>
            
                <li><a href="../classes/Event.Emitter.html">Event.Emitter</a></li>
            
                <li><a href="../classes/Event.Listener.html">Event.Listener</a></li>
            
                <li><a href="../classes/Function.html">Function</a></li>
            
                <li><a href="../classes/IO.html">IO</a></li>
            
                <li><a href="../classes/ITSA.html">ITSA</a></li>
            
                <li><a href="../classes/Object.html">Object</a></li>
            
                <li><a href="../classes/Parcel.html">Parcel</a></li>
            
                <li><a href="../classes/Parcel.EventListener.html">Parcel.EventListener</a></li>
            
                <li><a href="../classes/Parcel.Listener.html">Parcel.Listener</a></li>
            
                <li><a href="../classes/Parcela.html">Parcela</a></li>
            
                <li><a href="../classes/Promise.html">Promise</a></li>
            
                <li><a href="../classes/Promise.Resolver.html">Promise.Resolver</a></li>
            
                <li><a href="../classes/Router.html">Router</a></li>
            
                <li><a href="../classes/Utils.html">Utils</a></li>
            
                <li><a href="../classes/vDOM.html">vDOM</a></li>
            
                <li><a href="../classes/vNode.html">vNode</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/core.html">core</a></li>
            
                <li><a href="../modules/core-event.html">core-event</a></li>
            
                <li><a href="../modules/core-event-base.html">core-event-base</a></li>
            
                <li><a href="../modules/core-routing.html">core-routing</a></li>
            
                <li><a href="../modules/core-timers.html">core-timers</a></li>
            
                <li><a href="../modules/core-utils.html">core-utils</a></li>
            
                <li><a href="../modules/core-vdom.html">core-vdom</a></li>
            
                <li><a href="../modules/event.html">event</a></li>
            
                <li><a href="../modules/event-dom.html">event-dom</a></li>
            
                <li><a href="../modules/event-emitter.html">event-emitter</a></li>
            
                <li><a href="../modules/event-hammerjs.html">event-hammerjs</a></li>
            
                <li><a href="../modules/event-listener.html">event-listener</a></li>
            
                <li><a href="../modules/io.html">io</a></li>
            
                <li><a href="../modules/io-assets.html">io-assets</a></li>
            
                <li><a href="../modules/io-cors.html">io-cors</a></li>
            
                <li><a href="../modules/io-jsonp.html">io-jsonp</a></li>
            
                <li><a href="../modules/io-node.html">io-node</a></li>
            
                <li><a href="../modules/io-transfer.html">io-transfer</a></li>
            
                <li><a href="../modules/io-win.html">io-win</a></li>
            
                <li><a href="../modules/io-xml.html">io-xml</a></li>
            
                <li><a href="../modules/Object.html">Object</a></li>
            
                <li><a href="../modules/parcel.html">parcel</a></li>
            
                <li><a href="../modules/parcel-event-listener.html">parcel-event-listener</a></li>
            
                <li><a href="../modules/Parcela.html">Parcela</a></li>
            
                <li><a href="../modules/Promise.html">Promise</a></li>
            
                <li><a href="../modules/promise-ext.html">promise-ext</a></li>
            
                <li><a href="../modules/utils.html">utils</a></li>
            
                <li><a href="../modules/virtual-dom.html">virtual-dom</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/io/io-node.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 *
 * Provides core IO-functionality for NodeJS in the same way as &#x27;io-win.js&#x27; does on the browser.
 * This way, all IO-methods can be used inside nodejs as well.
 *
 * @module io
 * @submodule io-node
 * @class IO
*/

/* global module:false */

&quot;use strict&quot;;

require(&#x27;ypromise&#x27;);

var NAME = &#x27;[io-node]: &#x27;,
    http = require(&#x27;http&#x27;),
    xmlDOMParser = require(&#x27;xmldom&#x27;).DOMParser,
    querystring = require(&#x27;querystring&#x27;),
    DEF_REQ_TIMEOUT = 300000, // don&#x27;t create an ever-lasting request: always quit after 5 minutes
    MIME_JSON = &#x27;application/json&#x27;,
    BODY_METHODS = {
        POST: 1,
        PUT: 1
    },
    CONTENT_TYPE = &#x27;Content-Type&#x27;,
    DEF_CONTENT_TYPE_POST = &#x27;application/x-www-form-urlencoded; charset=UTF-8&#x27;,
    REQUEST_TIMEOUT = &#x27;Request-timeout&#x27;,
    ABORTED = &#x27;Request aborted&#x27;,
    REGEXP_EXTRACT_URL = new RegExp(&quot;^((([a-z][a-z0-9-.]*):\/\/)?(([^\/?#:]+)(:(\\d+))?)?)?(\/?[a-z0-9-._~%!$&amp;&#x27;()*+,;=@]+(\/[a-z0-9-._~%!$&amp;&#x27;()*+,;=:@]+)*\/?|\/)?([#?](.*)|$)&quot;, &quot;i&quot;),

IO = {
    config: {},

    //===============================================================================================
    // private methods:
    //===============================================================================================
    /**
     * Sends a HTTP request to the server and returns a Promise with an additional .abort() method to cancel the request.
     *
     * The promise gets fulfilled if the server responses with &#x60;STATUS-CODE&#x60; in the 200-range.
     * It will be rejected if a timeout occurs (see &#x60;options.timeout&#x60;), or if &#x60;xhr.abort()&#x60; gets invoked.
     *
     * CORS is supported, as long as the responseserver is set up to:
     *      a) has a response header which allows the clientdomain:
     *         header(&#x27;Access-Control-Allow-Origin: http://www.some-site.com&#x27;); or header(&#x27;Access-Control-Allow-Origin: *&#x27;);
     *      b) in cae you have set a custom HEADER (through &#x27;options&#x27;), the responseserver MUST listen and respond
     *         to requests with the OPTION-method
     *      More info:  allows to send to your domain: see http://remysharp.com/2011/04/21/getting-cors-working/
     *
     * @method _xhr
     * @param options {Object}
     *    @param [options.url] {String} The url to which the request is sent.
     *    @param [options.method=&#x27;GET&#x27;] {String} The HTTP method to use.
     *    can be ignored, even if streams are used --&gt; the returned Promise will always hold all data
 *    @param [options.data] {Object} Data to be sent to the server, either to be used by &#x60;query-params&#x60; or &#x60;body&#x60;.
     *    @param [options.headers] {Object} HTTP request headers.
     *    @param [options.timeout=3000] {number} to timeout the request, leading into a rejected Promise.
     * @return {Promise} Promise holding the request. Has an additional .abort() method to cancel the request.
     * &lt;ul&gt;
     *     &lt;li&gt;on success: xhr {XMLHttpRequest1|XMLHttpRequest2} xhr-response&lt;/li&gt;
     *     &lt;li&gt;on failure: reason {Error}&lt;/li&gt;
     * &lt;/ul&gt;
     * @private
    */
    _xhr: function(options) {
        console.log(NAME, &#x27;_xhrNodeJS&#x27;);
        var instance = this,
            rejectHandle, promise, request, timer;

        options || (options={});
        promise = new Promise(function(fulfill, reject) {
            var extractUrl = options.url.match(REGEXP_EXTRACT_URL),
                protocol = (extractUrl[3] || &#x27;&#x27;).toLowerCase(),
                host = extractUrl[5],
                port = extractUrl[7] || ((protocol===&#x27;https&#x27;) ? 443 : 80),
                path = extractUrl[8],
                getparams = extractUrl[11],
                data = options.data,
                headers = options.headers,
                method = options.method,
                xmlRequest = headers &amp;&amp; (headers.Accept===&#x27;text/xml&#x27;),
                isBodyMethod = BODY_METHODS[method],
                requestCallback, httpOptions;

            rejectHandle = reject;
            // if &#x27;host&#x27; could not be extracted from the url: reject the promise
            host || reject(&#x27;invalid url&#x27;);

            if (isBodyMethod) {
                // in case of POST or PUT method: always make sure &#x27;Content-Type&#x27; is specified
                headers || (headers={});
                (CONTENT_TYPE in headers) || (headers[CONTENT_TYPE]=DEF_CONTENT_TYPE_POST);
                if (data) {
                    data = (headers[CONTENT_TYPE]===MIME_JSON) ? JSON.stringify(data) : querystring.stringify(data);
                    headers[&#x27;Content-Length&#x27;] = Buffer.byteLength(data);
                }
            }
            else {
                headers &amp;&amp; (delete headers[CONTENT_TYPE]);
                if (getparams || data) {
                    path += &#x27;?&#x27;+(getparams || &#x27;&#x27;)+((getparams &amp;&amp; data) ? &#x27;&amp;&#x27; : &#x27;&#x27;) + (data ? querystring.stringify(data) : &#x27;&#x27;);
                }
            }
            httpOptions = {
                hostname: host,
                port: port,
                path: path,
                method: method,
                headers: headers
//                auth: Currently not setup in this module
            };
            requestCallback = function(response) {
                var str = &#x27;&#x27;;
                response.setEncoding(&#x27;utf8&#x27;);

                response.on(&#x27;data&#x27;, function (chunk) {
console.log(&#x27;received data: &#x27;+chunk);
                    str += chunk;
                });

                response.on(&#x27;end&#x27;, function () {
console.log(&#x27;END received data: &#x27;+response.statusCode);
                    var statusCode = response.statusCode,
                        responseobject;
                    if ((statusCode&gt;=200) &amp;&amp; (statusCode&lt;300)) {
                        // to remain consisten with XHR, we define an object with the same structure
                        responseobject = {
                            responseText: str,
                            responseXML: xmlRequest ? new xmlDOMParser().parseFromString(str) : null,
                            readyState: 4,
                            status: response.statusCode,
                            getAllResponseHeaders: function () {
                                 var headers = response.headers,
                                     headersStringified = &#x27;&#x27;;
                                 for(var key in headers) {
                                    if (headers.hasOwnProperty(key)) {
                                        headersStringified += &#x27;\r\n&#x27; + key + &#x27;: &#x27; + headers[key];
                                    }
                                 }
                                 (headersStringified.length&gt;0) &amp;&amp; (headersStringified=headersStringified.substr(2));
                                 return headersStringified;
                            },
                            getResponseHeader: function (name) {
                                return response.headers[name];
                            }
                        };
                        clearTimeout(timer);
                        fulfill(responseobject);
                    }
                    else {
                        clearTimeout(timer);
                        reject(&#x27;errorcode: &#x27;+statusCode);
                    }
                });
            };

            request = http.request(httpOptions, requestCallback);

            request.on(&#x27;error&#x27;, function(e) {
                clearTimeout(timer);
                reject(e.message);
            });
            timer = setTimeout(function() {
                reject(REQUEST_TIMEOUT);
                request.abort();
            }, options.timeout || instance.config.reqTimeout || DEF_REQ_TIMEOUT);

            isBodyMethod &amp;&amp; data &amp;&amp; request.write(data);
            request.end();
        });
        // now we need to add an &#x60;abort&#x60;-method:
        promise.abort = function() {
            clearTimeout(timer);
            rejectHandle(ABORTED);
            request.abort();
        };
        return promise;
    }
};

module.exports = IO;
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
